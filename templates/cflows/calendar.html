{% extends 'cflows/cflows_base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
    .fc-toolbar-title {
        font-size: 1.75rem !important;
        font-weight: 700 !important;
        color: #1f2937;
    }
    .fc-button {
        background: #3b82f6 !important;
        border-color: #3b82f6 !important;
        font-weight: 500 !important;
    }
    .fc-button:hover {
        background: #2563eb !important;
        border-color: #2563eb !important;
    }
    .fc-button-active {
        background: #1d4ed8 !important;
        border-color: #1d4ed8 !important;
    }
    .fc-daygrid-event {
        border-radius: 4px;
        font-weight: 500;
    }
    .fc-event-title {
        font-weight: 600;
    }
    .calendar-filters {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-section {
        margin-bottom: 1rem;
    }
    .filter-section:last-child {
        margin-bottom: 0;
    }
    .filter-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.875rem;
    }
    .filter-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        background: white;
        transition: all 0.15s ease-in-out;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    .filter-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .filter-select[multiple] {
        background-image: none;
        padding-right: 0.75rem;
        height: auto;
        min-height: 2.5rem;
    }
    .filter-select option {
        padding: 0.5rem;
        color: #374151;
    }
    .filter-select option:checked {
        background: #3b82f6;
        color: white;
    }
    .saved-views-dropdown {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        min-width: 16rem;
    }
    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    .legend-color {
        width: 1rem;
        height: 1rem;
        border-radius: 0.25rem;
    }
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal.hidden {
        display: none;
    }
    .modal-content {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .btn-primary {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-primary:hover {
        background: #2563eb;
    }
    .btn-secondary {
        background: #6b7280;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-secondary:hover {
        background: #4b5563;
    }
    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-danger:hover {
        background: #dc2626;
    }
    .priority-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .priority-low { background: #d1fae5; color: #065f46; }
    .priority-normal { background: #dbeafe; color: #1e3a8a; }
    .priority-high { background: #fef3c7; color: #92400e; }
    .priority-critical { background: #fee2e2; color: #991b1b; }
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    .status-scheduled { background: #e0e7ff; color: #3730a3; }
    .status-in_progress { background: #fef3c7; color: #92400e; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Team Calendar</h1>
            <p class="text-gray-600 mt-1">Manage team bookings and work item schedules</p>
        </div>
        <div class="flex gap-3">
            <button onclick="showCreateBookingModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>New Booking
            </button>
            <a href="{% url 'cflows:index' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="calendar-filters">
        <!-- Filter Header with Saved Views -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-4">
                <h3 class="text-lg font-semibold">Filters</h3>
                
                <!-- Saved Views Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="flex items-center px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-md">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 0 0 14-14 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9l6 6m0-6l-6 6"></path>
                        </svg>
                        Saved Views
                        <svg class="w-4 h-4 ml-2" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <div x-show="open" @click.away="open = false" x-transition class="absolute left-0 mt-2 saved-views-dropdown z-50">
                        <div class="py-2">
                            {% if saved_views %}
                                {% for view in saved_views %}
                                <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-50">
                                    <button onclick="loadSavedView({{ view.id }})" class="flex-1 text-left text-sm">
                                        {{ view.name }}
                                        {% if view.is_default %}<span class="text-xs text-blue-600">(Default)</span>{% endif %}
                                    </button>
                                    <button onclick="deleteSavedView({{ view.id }}, '{{ view.name }}')" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                                <div class="border-t pt-2">
                            {% endif %}
                                    <button onclick="showSaveViewModal()" class="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50">
                                        + Save Current View
                                    </button>
                            {% if saved_views %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="clearAllFilters()" class="text-sm text-blue-600 hover:text-blue-800">Clear All</button>
        </div>
        
        <form id="filterForm" method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Teams Filter -->
                <div class="filter-section">
                    <label class="filter-label">Teams</label>
                    <select name="team" multiple class="filter-select" id="teamFilter" onchange="applyFilters()">
                        {% for team in teams %}
                            <option value="{{ team.id }}" {% if team.id|stringformat:"s" in current_filters.teams %}selected{% endif %}>
                                {{ team.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="text-gray-500">Hold Ctrl/Cmd to select multiple</small>
                </div>
                
                <!-- Job Types Filter -->
                <div class="filter-section">
                    <label class="filter-label">Job Types</label>
                    <select name="job_type" multiple class="filter-select" id="jobTypeFilter" onchange="applyFilters()">
                        {% for job_type in job_types %}
                            <option value="{{ job_type.id }}" {% if job_type.id|stringformat:"s" in current_filters.job_types %}selected{% endif %}>
                                {{ job_type.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="text-gray-500">Hold Ctrl/Cmd to select multiple</small>
                </div>
                
                <!-- Workflows Filter -->
                <div class="filter-section">
                    <label class="filter-label">Workflows</label>
                    <select name="workflow" multiple class="filter-select" id="workflowFilter" onchange="applyFilters()">
                        {% for workflow in workflows %}
                            <option value="{{ workflow.id }}" {% if workflow.id|stringformat:"s" in current_filters.workflows %}selected{% endif %}>
                                {{ workflow.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="text-gray-500">Hold Ctrl/Cmd to select multiple</small>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-section">
                    <label class="filter-label">Status</label>
                    <select name="status" class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="pending" {% if current_filters.status == "pending" %}selected{% endif %}>Pending</option>
                        <option value="completed" {% if current_filters.status == "completed" %}selected{% endif %}>Completed</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Event Type Filter -->
                <div class="filter-section">
                    <label class="filter-label">Event Type</label>
                    <select name="event_type" class="filter-select" id="eventTypeFilter" onchange="applyFilters()">
                        <option value="">All Event Types</option>
                        <option value="meeting" {% if current_filters.event_type == "meeting" %}selected{% endif %}>Meeting</option>
                        <option value="training" {% if current_filters.event_type == "training" %}selected{% endif %}>Training</option>
                        <option value="maintenance" {% if current_filters.event_type == "maintenance" %}selected{% endif %}>Maintenance</option>
                        <option value="other" {% if current_filters.event_type == "other" %}selected{% endif %}>Other</option>
                    </select>
                </div>
                
                <!-- Booked By Filter -->
                <div class="filter-section">
                    <label class="filter-label">Booked By</label>
                    <select name="booked_by" class="filter-select" id="bookedByFilter" onchange="applyFilters()">
                        <option value="">All Users</option>
                        {% for user in users_with_bookings %}
                            <option value="{{ user.id }}" {% if current_filters.booked_by == user.id|stringformat:"s" %}selected{% endif %}>
                                {{ user.user.get_full_name|default:user.user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
        
        <!-- Legend -->
        <div class="border-t border-gray-200 pt-4 mt-4">
            <h4 class="font-medium text-gray-700 mb-3">Legend</h4>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span>Scheduled Bookings</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>Completed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span>Calendar Events</span>
                </div>
            </div>
        </div>
    </div>
                </select>
            </div>
            <div class="filter-section">
                <label class="filter-label">Status</label>
                <select id="statusFilter" class="filter-select" onchange="filterCalendar()">
                    <option value="">All Status</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
        <div class="legend">
            <span class="font-semibold text-gray-700 mr-2">Priority Colors:</span>
            <div class="legend-item">
                <div class="legend-color" style="background: #10b981;"></div>
                <span>Low</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3b82f6;"></div>
                <span>Normal</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f59e0b;"></div>
                <span>High</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>Critical</span>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div id="calendar"></div>
    </div>
</div>

<!-- Create/Edit Booking Modal -->
<div id="bookingModal" class="modal hidden">
    <div class="modal-content">
        <h3 id="bookingModalTitle" class="text-xl font-semibold mb-4">Create Booking</h3>
        <form id="bookingForm">
            <div class="form-group">
                <label for="workItemSelect" class="form-label">Work Item <span class="text-red-500">*</span></label>
                <select id="workItemSelect" class="form-select" required>
                    <option value="">Select work item...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="teamSelect" class="form-label">Team <span class="text-red-500">*</span></label>
                <select id="teamSelect" class="form-select" required onchange="loadTeamMembers()">
                    <option value="">Select team...</option>
                    {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="startDate" class="form-label">Start Date <span class="text-red-500">*</span></label>
                    <input type="date" id="startDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="endDate" class="form-label">End Date <span class="text-red-500">*</span></label>
                    <input type="date" id="endDate" class="form-input" required>
                </div>
            </div>
            <div class="form-group">
                <label for="assignedToSelect" class="form-label">Assigned To</label>
                <select id="assignedToSelect" class="form-select">
                    <option value="">No specific assignment</option>
                </select>
            </div>
            <div class="form-group">
                <label for="statusSelect" class="form-label">Status</label>
                <select id="statusSelect" class="form-select">
                    <option value="scheduled">Scheduled</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notesTextarea" class="form-label">Notes</label>
                <textarea id="notesTextarea" class="form-textarea" rows="3" placeholder="Additional notes..."></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeBookingModal()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="deleteBooking()" id="deleteBookingBtn" class="btn-danger hidden">Delete</button>
                <button type="submit" class="btn-primary">Save Booking</button>
            </div>
        </form>
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventModal" class="modal hidden">
    <div class="modal-content">
        <h3 id="eventModalTitle" class="text-xl font-semibold mb-4">Event Details</h3>
        <div id="eventDetails"></div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeEventModal()" class="btn-secondary">Close</button>
            <button onclick="editEvent()" id="editEventBtn" class="btn-primary">Edit</button>
        </div>
    </div>
</div>

<!-- Save Calendar View Modal -->
<div id="saveViewModal" class="modal hidden">
    <div class="modal-content">
        <h3 class="text-xl font-semibold mb-4">Save Calendar View</h3>
        <form id="saveViewForm">
            <div class="form-group">
                <label class="form-label">View Name</label>
                <input type="text" id="viewName" class="form-input" placeholder="Enter view name" required>
            </div>
            <div class="form-group">
                <label class="flex items-center">
                    <input type="checkbox" id="isDefault" class="mr-2">
                    <span class="text-sm">Set as default view</span>
                </label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeSaveViewModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Save View</button>
            </div>
        </form>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
let calendar;
let currentBookingId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const form = document.getElementById('filterForm');
    
    // Set form values from URL parameters
    urlParams.forEach((value, key) => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'select-multiple') {
                // Handle multi-select fields
                const options = input.querySelectorAll('option');
                options.forEach(option => {
                    if (urlParams.getAll(key).includes(option.value)) {
                        option.selected = true;
                    }
                });
            } else {
                input.value = value;
            }
        }
    });
    
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        droppable: true,
        events: function(fetchInfo, successCallback, failureCallback) {
            // Get current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const eventUrl = new URL('{% url "cflows:calendar_events" %}', window.location.origin);
            
            // Add URL parameters to event fetch
            urlParams.forEach((value, key) => {
                eventUrl.searchParams.append(key, value);
            });
            
            fetch(eventUrl)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        eventDrop: function(info) {
            updateBookingDates(info.event);
        },
        eventResize: function(info) {
            updateBookingDates(info.event);
        },
        dateClick: function(info) {
            showCreateBookingModal(info.dateStr);
        }
    });
    
    calendar.render();
    loadWorkItems();
});

function showCreateBookingModal(dateStr = null) {
    currentBookingId = null;
    document.getElementById('bookingModalTitle').textContent = 'Create Booking';
    document.getElementById('deleteBookingBtn').classList.add('hidden');
    
    // Reset form
    document.getElementById('bookingForm').reset();
    
    // Set date if provided
    if (dateStr) {
        document.getElementById('startDate').value = dateStr;
        document.getElementById('endDate').value = dateStr;
    }
    
    document.getElementById('bookingModal').classList.remove('hidden');
}

function showEventDetails(event) {
    const props = event.extendedProps;
    
    if (props.type === 'booking') {
        showEditBookingModal(props.bookingId);
    } else {
        // Show read-only event details
        document.getElementById('eventModalTitle').textContent = event.title;
        
        let detailsHtml = `
            <div class="space-y-3">
                <div><strong>Type:</strong> ${props.type === 'event' ? 'Calendar Event' : 'Work Item Due Date'}</div>
                <div><strong>Start:</strong> ${event.start.toLocaleDateString()}</div>
        `;
        
        if (event.end) {
            detailsHtml += `<div><strong>End:</strong> ${event.end.toLocaleDateString()}</div>`;
        }
        
        if (props.description) {
            detailsHtml += `<div><strong>Description:</strong> ${props.description}</div>`;
        }
        
        if (props.location) {
            detailsHtml += `<div><strong>Location:</strong> ${props.location}</div>`;
        }
        
        detailsHtml += `</div>`;
        
        document.getElementById('eventDetails').innerHTML = detailsHtml;
        document.getElementById('editEventBtn').style.display = props.type === 'booking' ? 'inline-block' : 'none';
        document.getElementById('eventModal').classList.remove('hidden');
    }
}

function showEditBookingModal(bookingId) {
    fetch(`{% url 'cflows:booking_detail' 0 %}`.replace('0', bookingId))
        .then(response => response.json())
        .then(data => {
            currentBookingId = bookingId;
            document.getElementById('bookingModalTitle').textContent = 'Edit Booking';
            document.getElementById('deleteBookingBtn').classList.remove('hidden');
            
            // Populate form
            document.getElementById('workItemSelect').value = data.work_item.id;
            document.getElementById('teamSelect').value = data.team.id;
            document.getElementById('startDate').value = data.start_date;
            document.getElementById('endDate').value = data.end_date;
            document.getElementById('statusSelect').value = data.status;
            document.getElementById('notesTextarea').value = data.notes || '';
            
            // Load team members and set assignment
            loadTeamMembers().then(() => {
                if (data.assigned_to) {
                    document.getElementById('assignedToSelect').value = data.assigned_to.id;
                }
            });
            
            document.getElementById('bookingModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error loading booking details:', error);
            alert('Error loading booking details');
        });
}

function closeBookingModal() {
    document.getElementById('bookingModal').classList.add('hidden');
    currentBookingId = null;
}

function closeEventModal() {
    document.getElementById('eventModal').classList.add('hidden');
}

function editEvent() {
    closeEventModal();
    // This would open edit modal for the event
}

function loadWorkItems() {
    // Load work items that can be booked
    fetch('{% url "cflows:work_items_list" %}?api=true')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('workItemSelect');
            select.innerHTML = '<option value="">Select work item...</option>';
            
            if (data.work_items) {
                data.work_items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.title} (${item.workflow})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading work items:', error));
}

function loadTeamMembers() {
    return new Promise((resolve) => {
        const teamId = document.getElementById('teamSelect').value;
        const assignedToSelect = document.getElementById('assignedToSelect');
        
        assignedToSelect.innerHTML = '<option value="">No specific assignment</option>';
        
        if (!teamId) {
            resolve();
            return;
        }
        
        // This would fetch team members from an API endpoint
        // For now, we'll just resolve immediately
        resolve();
    });
}

function updateBookingDates(event) {
    const props = event.extendedProps;
    
    if (props.type !== 'booking') return;
    
    const data = {
        start_date: event.start.toISOString().split('T')[0],
        end_date: event.end ? new Date(event.end.getTime() - 24*60*60*1000).toISOString().split('T')[0] : event.start.toISOString().split('T')[0]
    };
    
    fetch(`{% url 'cflows:update_booking' 0 %}`.replace('0', props.bookingId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            alert('Error updating booking: ' + result.error);
            calendar.refetchEvents();
        }
    })
    .catch(error => {
        console.error('Error updating booking:', error);
        calendar.refetchEvents();
    });
}

function deleteBooking() {
    if (!currentBookingId) return;
    
    if (!confirm('Are you sure you want to delete this booking?')) return;
    
    fetch(`{% url 'cflows:delete_booking' 0 %}`.replace('0', currentBookingId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeBookingModal();
            calendar.refetchEvents();
        } else {
            alert('Error deleting booking: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error deleting booking:', error);
        alert('Error deleting booking');
    });
}

function applyFilters() {
    // Get current URL without existing filters
    const baseUrl = window.location.pathname;
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    // Build query string from form data
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            params.append(key, value);
        }
    }
    
    // Update URL with filters
    const newUrl = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    window.history.replaceState(null, '', newUrl);
    
    // Refresh calendar with new filters
    calendar.refetchEvents();
}

function clearAllFilters() {
    // Reset all form fields
    document.getElementById('filterForm').reset();
    
    // Clear URL parameters
    window.history.replaceState(null, '', window.location.pathname);
    
    // Refresh calendar
    calendar.refetchEvents();
}

function filterCalendar() {
    // Legacy function for backward compatibility
    applyFilters();
}

// Handle booking form submission
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        work_item_id: document.getElementById('workItemSelect').value,
        team_id: document.getElementById('teamSelect').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        assigned_to_id: document.getElementById('assignedToSelect').value || null,
        status: document.getElementById('statusSelect').value,
        notes: document.getElementById('notesTextarea').value
    };
    
    if (!formData.work_item_id || !formData.team_id || !formData.start_date || !formData.end_date) {
        alert('Please fill in all required fields');
        return;
    }
    
    const url = currentBookingId 
        ? `{% url 'cflows:update_booking' 0 %}`.replace('0', currentBookingId)
        : '{% url "cflows:create_booking" %}';
    
    const method = 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeBookingModal();
            calendar.refetchEvents();
        } else {
            alert('Error saving booking: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error saving booking:', error);
        alert('Error saving booking');
    });
});

// Calendar View Management Functions
function showSaveViewModal() {
    document.getElementById('viewName').value = '';
    document.getElementById('isDefault').checked = false;
    document.getElementById('saveViewModal').classList.remove('hidden');
}

function closeSaveViewModal() {
    document.getElementById('saveViewModal').classList.add('hidden');
}

function loadSavedView(viewId) {
    window.location.href = `/services/cflows/calendar/views/load/${viewId}/`;
}

function deleteSavedView(viewId, viewName) {
    if (confirm(`Are you sure you want to delete the view "${viewName}"?`)) {
        fetch(`/services/cflows/calendar/views/delete/${viewId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Reload to update the saved views list
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting view:', error);
            alert('Error deleting view');
        });
    }
}

// Handle Save View Form Submission
document.getElementById('saveViewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const viewName = document.getElementById('viewName').value.trim();
    const isDefault = document.getElementById('isDefault').checked;
    
    if (!viewName) {
        alert('Please enter a view name');
        return;
    }
    
    // Get current URL parameters (filters)
    const params = new URLSearchParams(window.location.search);
    
    fetch('/services/cflows/calendar/views/save/?' + params.toString(), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: viewName,
            is_default: isDefault
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeSaveViewModal();
            location.reload(); // Reload to update the saved views list
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving view:', error);
        alert('Error saving view');
    });
});
</script>
{% endblock %}
