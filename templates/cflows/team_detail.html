{% extends 'cflows/cflows_base.html' %}

{% block title %}{{ team.name }} - Teams - CFlows{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Page Header -->
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2 text-sm text-gray-500">
                    <li><a href="{% url 'cflows:teams_list' %}" class="hover:text-indigo-600">Teams</a></li>
                    
                    <!-- Show team hierarchy in breadcrumb -->
                    {% for team_in_path in team.get_team_path %}
                        <li><i class="fas fa-chevron-right text-xs"></i></li>
                        {% if forloop.last %}
                            <li class="text-gray-900">{{ team_in_path.name }}</li>
                        {% else %}
                            <li><a href="{% url 'cflows:team_detail' team_in_path.id %}" class="hover:text-indigo-600">{{ team_in_path.name }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ol>
            </nav>
            <div class="flex items-center mt-2">
                <h1 class="text-3xl font-bold text-gray-900">{{ team.name }}</h1>
                {% if team.parent_team %}
                    <span class="ml-3 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-sitemap mr-1"></i>
                        Sub-team of {{ team.parent_team.name }}
                    </span>
                {% endif %}
            </div>
            <div class="flex items-center mt-2 space-x-4">
                {% if team.is_active %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <i class="fas fa-check-circle mr-1"></i>
                    Active
                </span>
                {% else %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    <i class="fas fa-times-circle mr-1"></i>
                    Inactive
                </span>
                {% endif %}
                <span class="text-sm text-gray-500">{{ stats.member_count }} member{{ stats.member_count|pluralize }}</span>
                {% if team.is_parent_team %}
                    <span class="text-sm text-gray-500">{{ team.sub_teams.count }} sub-team{{ team.sub_teams.count|pluralize }}</span>
                {% endif %}
            </div>
        </div>
        {% if can_manage %}
        <div class="mt-4 sm:mt-0 flex gap-3">
            <a href="{% url 'cflows:edit_team' team.id %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-edit mr-2"></i>
                Edit Team
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Team Description -->
    {% if team.description %}
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-3">Description</h2>
        <p class="text-gray-700">{{ team.description }}</p>
    </div>
    {% endif %}

    <!-- Team Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-indigo-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900">{{ stats.member_count }}</h3>
                    <p class="text-sm text-gray-500">Team Members</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900">{{ stats.total_bookings }}</h3>
                    <p class="text-sm text-gray-500">Total Bookings</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900">{{ stats.active_bookings }}</h3>
                    <p class="text-sm text-gray-500">Active Bookings</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check text-green-600"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-2xl font-bold text-gray-900">{{ stats.completed_bookings }}</h3>
                    <p class="text-sm text-gray-500">Completed Bookings</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Configuration -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Team Configuration</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="text-sm font-medium text-gray-500">Default Capacity</label>
                <p class="text-lg text-gray-900">{{ team.default_capacity }} members</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Team Color</label>
                <div class="flex items-center mt-1">
                    <div class="w-8 h-8 rounded border border-gray-300 mr-3" style="background-color: {{ team.color }};"></div>
                    <p class="text-lg text-gray-900">{{ team.color }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Members -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Team Members</h2>
            {% if can_manage and available_users %}
            <button type="button" 
                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200"
                    onclick="document.getElementById('add-member-modal').classList.remove('hidden')">
                <i class="fas fa-plus mr-2"></i>
                Add Member
            </button>
            {% endif %}
        </div>
        
        {% if team_members %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for member in team_members %}
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-600 text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">
                            {{ member.user.get_full_name|default:member.user.username }}
                        </p>
                        {% if member.title %}
                        <p class="text-xs text-gray-500">{{ member.title }}</p>
                        {% endif %}
                    </div>
                </div>
                {% if can_manage %}
                <form method="post" class="ml-2" onsubmit="return confirm('Remove this member from the team?')">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ member.id }}">
                    <button type="submit" name="remove_member" 
                            class="text-red-400 hover:text-red-600" 
                            title="Remove from team">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-users text-gray-400 text-3xl mb-3"></i>
            <p class="text-gray-500">No team members yet.</p>
            {% if can_manage and available_users %}
            <button type="button" 
                    class="mt-4 inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
                    onclick="document.getElementById('add-member-modal').classList.remove('hidden')">
                <i class="fas fa-plus mr-2"></i>
                Add First Member
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Sub-teams Section -->
{% if team.is_parent_team %}
<div class="bg-white rounded-lg border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-lg font-semibold text-gray-900">Sub-teams</h2>
            <p class="text-sm text-gray-600">Teams under {{ team.name }}</p>
        </div>
        {% if can_manage %}
        <a href="{% url 'cflows:create_team' %}?parent={{ team.id }}" 
           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
            <i class="fas fa-plus mr-2"></i>
            Add Sub-team
        </a>
        {% endif %}
    </div>
    
    {% if team.sub_teams.exists %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for sub_team in team.sub_teams.all %}
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3"
                         style="background-color: {{ sub_team.color|default:'#007bff' }}15;">
                        <i class="fas fa-users" style="color: {{ sub_team.color|default:'#007bff' }};"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium text-gray-900">
                            <a href="{% url 'cflows:team_detail' sub_team.id %}" class="hover:text-indigo-600">
                                {{ sub_team.name }}
                            </a>
                        </h3>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>{{ sub_team.member_count }} member{{ sub_team.member_count|pluralize }}</span>
                            {% if sub_team.sub_teams.exists %}
                                <span>{{ sub_team.sub_teams.count }} sub-team{{ sub_team.sub_teams.count|pluralize }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if can_manage %}
                <a href="{% url 'cflows:edit_team' sub_team.id %}" 
                   class="text-gray-400 hover:text-indigo-600" 
                   title="Edit Sub-team">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-8">
        <i class="fas fa-sitemap text-gray-400 text-3xl mb-3"></i>
        <p class="text-gray-500">No sub-teams yet.</p>
        {% if can_manage %}
        <a href="{% url 'cflows:create_team' %}?parent={{ team.id }}" 
           class="mt-3 inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
            <i class="fas fa-plus mr-2"></i>
            Create First Sub-team
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Add Member Modal -->
{% if can_manage and available_users %}
<div id="add-member-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Team Member</h3>
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
                <select name="user_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">Choose a user...</option>
                    {% for user in available_users %}
                    <option value="{{ user.id }}">
                        {{ user.user.get_full_name|default:user.user.username }}
                        {% if user.title %} - {{ user.title }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
                        onclick="document.getElementById('add-member-modal').classList.add('hidden')">
                    Cancel
                </button>
                <button type="submit" name="add_member" 
                        class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-indigo-700">
                    Add Member
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
