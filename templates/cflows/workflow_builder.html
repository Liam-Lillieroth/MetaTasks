{% extends 'cflows/cflows_base.html' %}

{% block title %}{{ page_title }} - CFlows{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg p-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Workflow Builder</h1>
                <p class="mt-2 text-indigo-100">Create workflows from templates or build completely custom processes</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="bg-white/20 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold">{{ templates.count }}</div>
                    <div class="text-sm text-indigo-100">Templates</div>
                </div>
                <div class="bg-white/20 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold">{{ teams.count }}</div>
                    <div class="text-sm text-indigo-100">Teams</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Creation Options -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Template-Based Creation -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-clone text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Use Template</h2>
                    <p class="text-sm text-gray-600">Start with a predefined workflow template</p>
                </div>
            </div>

            {% if template_categories %}
                <!-- Template Categories -->
                <div class="space-y-6">
                    {% for category, category_templates in template_categories.items %}
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-folder-open text-gray-400 mr-2"></i>
                            {{ category }}
                        </h3>
                        <div class="space-y-3">
                            {% for template in category_templates %}
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900">{{ template.name }}</h4>
                                        <p class="text-sm text-gray-600 mt-1">{{ template.description }}</p>
                                        <div class="flex items-center mt-2 text-xs text-gray-500">
                                            <span class="bg-gray-100 px-2 py-1 rounded mr-2">
                                                {{ template.template_data.steps|length }} steps
                                            </span>
                                            <span class="bg-gray-100 px-2 py-1 rounded mr-2">
                                                Used {{ template.usage_count }} times
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button onclick="previewTemplate({{ template.id }})" 
                                                class="inline-flex items-center px-3 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-eye mr-1"></i>
                                            Preview
                                        </button>
                                        <button onclick="useTemplate({{ template.id }})" 
                                                class="inline-flex items-center px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            <i class="fas fa-plus mr-1"></i>
                                            Use Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>No templates available</p>
                </div>
            {% endif %}
        </div>

        <!-- Custom Creation -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-cogs text-green-600 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Build Custom</h2>
                    <p class="text-sm text-gray-600">Create a completely custom workflow</p>
                </div>
            </div>

            <!-- Custom Workflow Builder -->
            <div class="space-y-6">
                <!-- Quick Start Options -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button onclick="startBlankWorkflow()" 
                            class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-green-400 hover:bg-green-50 transition-colors">
                        <i class="fas fa-plus-circle text-green-600 text-2xl mb-2"></i>
                        <div class="text-sm font-medium text-gray-900">Start from Scratch</div>
                        <div class="text-xs text-gray-500">Build step by step</div>
                    </button>
                    
                    <button onclick="useQuickBuilder()" 
                            class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-green-400 hover:bg-green-50 transition-colors">
                        <i class="fas fa-magic text-green-600 text-2xl mb-2"></i>
                        <div class="text-sm font-medium text-gray-900">Quick Builder</div>
                        <div class="text-xs text-gray-500">List step names</div>
                    </button>
                </div>

                <!-- Sample Workflow Ideas -->
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Sample Workflow Ideas</h4>
                    <div class="space-y-2">
                        <button onclick="loadSampleWorkflow('approval')" 
                                class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="font-medium text-sm text-gray-900">Approval Process</div>
                            <div class="text-xs text-gray-600">Submit → Review → Approve → Complete</div>
                        </button>
                        
                        <button onclick="loadSampleWorkflow('support')" 
                                class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="font-medium text-sm text-gray-900">Support Ticket</div>
                            <div class="text-xs text-gray-600">Open → Assign → Work → Test → Close</div>
                        </button>
                        
                        <button onclick="loadSampleWorkflow('production')" 
                                class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="font-medium text-sm text-gray-900">Production Process</div>
                            <div class="text-xs text-gray-600">Order → Plan → Build → QC → Ship</div>
                        </button>
                    </div>
                </div>

                <!-- Available Teams -->
                {% if teams %}
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Available Teams</h4>
                    <div class="max-h-40 overflow-y-auto space-y-2">
                        {% for team in teams %}
                        <div class="flex items-center p-2 bg-gray-50 rounded">
                            <div class="w-6 h-6 bg-indigo-100 rounded-full flex items-center justify-center mr-2">
                                <i class="fas fa-users text-indigo-600 text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">{{ team.name }}</div>
                                <div class="text-xs text-gray-500">{{ team.members.count }} members</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Templates Usage -->
    {% if templates %}
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Popular Templates</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for template in templates|slice:":4" %}
            <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-300 transition-colors">
                <div class="text-center">
                    <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-star text-indigo-600"></i>
                    </div>
                    <h4 class="font-medium text-gray-900 mb-1">{{ template.name }}</h4>
                    <p class="text-xs text-gray-600 mb-3">{{ template.template_data.steps|length }} steps</p>
                    <button onclick="useTemplate({{ template.id }})" 
                            class="w-full text-sm bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition-colors">
                        Use Template
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Template Preview Modal -->
<div id="templatePreviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900" id="previewModalTitle">Template Preview</h3>
                <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="templatePreviewContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="flex items-center justify-between p-6 border-t border-gray-200">
                <button onclick="closePreviewModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <div class="flex items-center space-x-3">
                    <button id="customizeTemplateBtn" onclick="customizeTemplate()" 
                            class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded-md hover:bg-indigo-50">
                        Customize
                    </button>
                    <button id="useTemplateBtn" onclick="useTemplateFromPreview()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Use As-Is
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Creation Modal -->
<div id="workflowCreationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900" id="creationModalTitle">Create Workflow</h3>
                <button onclick="closeCreationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                <form id="workflowCreationForm" class="space-y-6">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Workflow Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="workflow_name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                               placeholder="Enter workflow name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Description
                        </label>
                        <textarea name="workflow_description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                  placeholder="Describe this workflow's purpose..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Owner Team <span class="text-red-500">*</span>
                        </label>
                        <select name="owner_team" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select owner team...</option>
                            {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="customStepsSection" class="hidden">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-medium text-gray-700">
                                Workflow Steps
                            </label>
                            <button type="button" onclick="addCustomStep()" 
                                    class="text-sm bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700">
                                <i class="fas fa-plus mr-1"></i>
                                Add Step
                            </button>
                        </div>
                        <div id="customStepsList" class="space-y-3">
                            <!-- Steps will be added dynamically -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex items-center justify-between p-6 border-t border-gray-200">
                <button onclick="closeCreationModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="submitWorkflowCreation()" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>
                    Create Workflow
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTemplateId = null;
let currentCreationType = null;
let stepCounter = 0;

// Template Functions
function previewTemplate(templateId) {
    fetch(`/services/cflows/template-preview/${templateId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTemplatePreview(data.template);
                currentTemplateId = templateId;
                document.getElementById('templatePreviewModal').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load template preview');
        });
}

function displayTemplatePreview(template) {
    document.getElementById('previewModalTitle').textContent = template.name;
    
    const content = document.getElementById('templatePreviewContent');
    content.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">${template.name}</h4>
                <p class="text-gray-600">${template.description}</p>
                <span class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full mt-2">
                    ${template.category}
                </span>
            </div>
            
            <div>
                <h5 class="font-medium text-gray-900 mb-3">Workflow Steps (${template.steps.length})</h5>
                <div class="space-y-3">
                    ${template.steps.map((step, index) => `
                        <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                <span class="text-sm font-medium text-indigo-600">${step.order || index + 1}</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${step.name}</div>
                                ${step.description ? `<div class="text-sm text-gray-600 mt-1">${step.description}</div>` : ''}
                                <div class="flex items-center mt-2 space-x-4 text-xs text-gray-500">
                                    ${step.requires_booking ? '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Requires Booking</span>' : ''}
                                    ${step.estimated_duration_hours ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded">${step.estimated_duration_hours}h estimated</span>` : ''}
                                    ${step.is_terminal ? '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">Final Step</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Set up action buttons
    document.getElementById('useTemplateBtn').onclick = () => useTemplateFromPreview();
    document.getElementById('customizeTemplateBtn').onclick = () => customizeTemplate();
}

function useTemplate(templateId) {
    currentTemplateId = templateId;
    currentCreationType = 'template';
    document.getElementById('creationModalTitle').textContent = 'Create Workflow from Template';
    document.getElementById('customStepsSection').classList.add('hidden');
    document.getElementById('workflowCreationModal').classList.remove('hidden');
}

function useTemplateFromPreview() {
    closePreviewModal();
    useTemplate(currentTemplateId);
}

function customizeTemplate() {
    closePreviewModal();
    // Load template for customization
    currentCreationType = 'customize';
    document.getElementById('creationModalTitle').textContent = 'Customize Template';
    document.getElementById('customStepsSection').classList.remove('hidden');
    
    // Load template steps for editing
    fetch(`/services/cflows/template-preview/${currentTemplateId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTemplateStepsForCustomization(data.template.steps);
                document.getElementById('workflowCreationModal').classList.remove('hidden');
            }
        });
}

// Custom Workflow Functions
function startBlankWorkflow() {
    currentCreationType = 'custom';
    currentTemplateId = null;
    document.getElementById('creationModalTitle').textContent = 'Create Custom Workflow';
    document.getElementById('customStepsSection').classList.remove('hidden');
    clearCustomSteps();
    addCustomStep();
    document.getElementById('workflowCreationModal').classList.remove('hidden');
}

function useQuickBuilder() {
    // Show a simple text area for step names
    currentCreationType = 'quick';
    currentTemplateId = null;
    document.getElementById('creationModalTitle').textContent = 'Quick Workflow Builder';
    document.getElementById('customStepsSection').innerHTML = `
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Step Names (one per line)
            </label>
            <textarea id="quickStepsInput" rows="6" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      placeholder="Enter step names, one per line:&#10;Step 1: Initial Review&#10;Step 2: Processing&#10;Step 3: Final Approval"></textarea>
            <p class="text-sm text-gray-500 mt-1">Each line will become a workflow step in order</p>
        </div>
    `;
    document.getElementById('customStepsSection').classList.remove('hidden');
    document.getElementById('workflowCreationModal').classList.remove('hidden');
}

function loadSampleWorkflow(type) {
    const samples = {
        'approval': ['Submit Request', 'Initial Review', 'Manager Approval', 'Final Processing', 'Complete'],
        'support': ['Ticket Created', 'Assigned to Agent', 'In Progress', 'Testing', 'Resolved'],
        'production': ['Order Received', 'Production Planning', 'Manufacturing', 'Quality Control', 'Shipped']
    };
    
    if (samples[type]) {
        useQuickBuilder();
        document.getElementById('quickStepsInput').value = samples[type].join('\n');
    }
}

function addCustomStep() {
    stepCounter++;
    const stepsList = document.getElementById('customStepsList');
    const stepDiv = document.createElement('div');
    stepDiv.className = 'border border-gray-200 rounded-lg p-4';
    stepDiv.id = `customStep${stepCounter}`;
    
    stepDiv.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <h5 class="font-medium text-gray-900">Step ${stepCounter}</h5>
            <button type="button" onclick="removeCustomStep(${stepCounter})" 
                    class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" name="step_name_${stepCounter}" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="Enter step name">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Team</label>
                <select name="step_team_${stepCounter}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="">No specific team</option>
                    {% for team in teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <input type="text" name="step_description_${stepCounter}"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="Optional step description">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
            <div class="flex items-center">
                <input type="checkbox" name="step_booking_${stepCounter}" 
                       class="rounded text-indigo-600 focus:ring-indigo-500">
                <label class="ml-2 text-sm text-gray-700">Requires resource booking</label>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Est. Duration (hours)</label>
                <input type="number" name="step_duration_${stepCounter}" step="0.5" min="0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="2.0">
            </div>
        </div>
        
        <!-- Custom Fields for this Step -->
        <div class="mt-4 border-t border-gray-200 pt-4">
            <div class="flex items-center justify-between mb-3">
                <label class="block text-sm font-medium text-gray-700">Custom Data Fields</label>
                <button type="button" onclick="addCustomField(${stepCounter})" 
                        class="text-sm bg-purple-600 text-white px-3 py-1 rounded-md hover:bg-purple-700">
                    <i class="fas fa-plus mr-1"></i>
                    Add Field
                </button>
            </div>
            <div id="customFields${stepCounter}" class="space-y-3">
                <!-- Custom fields will be added here -->
            </div>
        </div>
    `;
    
    stepsList.appendChild(stepDiv);
}

function removeCustomStep(stepId) {
    const stepDiv = document.getElementById(`customStep${stepId}`);
    if (stepDiv) {
        stepDiv.remove();
    }
}

function clearCustomSteps() {
    document.getElementById('customStepsList').innerHTML = '';
    stepCounter = 0;
}

function loadTemplateStepsForCustomization(steps) {
    clearCustomSteps();
    steps.forEach((step, index) => {
        addCustomStep();
        const stepDiv = document.getElementById(`customStep${stepCounter}`);
        
        // Populate with template data
        stepDiv.querySelector(`input[name="step_name_${stepCounter}"]`).value = step.name;
        stepDiv.querySelector(`input[name="step_description_${stepCounter}"]`).value = step.description || '';
        if (step.requires_booking) {
            stepDiv.querySelector(`input[name="step_booking_${stepCounter}"]`).checked = true;
        }
        if (step.estimated_duration_hours) {
            stepDiv.querySelector(`input[name="step_duration_${stepCounter}"]`).value = step.estimated_duration_hours;
        }
    });
}

// Modal Functions
function closePreviewModal() {
    document.getElementById('templatePreviewModal').classList.add('hidden');
    currentTemplateId = null;
}

function closeCreationModal() {
    document.getElementById('workflowCreationModal').classList.add('hidden');
    document.getElementById('workflowCreationForm').reset();
    clearCustomSteps();
    currentTemplateId = null;
    currentCreationType = null;
}

// Form Submission
function submitWorkflowCreation() {
    const form = document.getElementById('workflowCreationForm');
    const formData = new FormData(form);
    
    if (currentCreationType === 'quick') {
        // Handle quick builder
        const stepsText = document.getElementById('quickStepsInput').value;
        const steps = stepsText.split('\n').filter(line => line.trim()).map(line => ({
            name: line.trim().replace(/^\d+[:.]\s*/, ''), // Remove leading numbers
            description: '',
            requires_booking: false
        }));
        formData.append('steps_data', JSON.stringify(steps));
        submitCustomWorkflow(formData);
    } else if (currentCreationType === 'custom') {
        // Handle custom steps
        const steps = collectCustomSteps();
        formData.append('steps_data', JSON.stringify(steps));
        submitCustomWorkflow(formData);
    } else if (currentCreationType === 'customize') {
        // Handle customized template
        const steps = collectCustomSteps();
        formData.append('custom_steps_data', JSON.stringify(steps));
        submitCustomizedTemplate(formData);
    } else if (currentCreationType === 'template') {
        // Handle template-based creation
        submitTemplateWorkflow(formData);
    }
}

function collectCustomSteps() {
    const steps = [];
    const stepDivs = document.querySelectorAll('#customStepsList > div');
    
    stepDivs.forEach((stepDiv, index) => {
        const stepId = stepDiv.id.replace('customStep', '');
        const name = stepDiv.querySelector(`input[name="step_name_${stepId}"]`).value;
        
        if (name.trim()) {
            steps.push({
                name: name.trim(),
                description: stepDiv.querySelector(`input[name="step_description_${stepId}"]`).value,
                requires_booking: stepDiv.querySelector(`input[name="step_booking_${stepId}"]`).checked,
                estimated_duration_hours: parseFloat(stepDiv.querySelector(`input[name="step_duration_${stepId}"]`).value) || null,
                assigned_team_id: stepDiv.querySelector(`select[name="step_team_${stepId}"]`).value || null
            });
        }
    });
    
    return steps;
}

function submitTemplateWorkflow(formData) {
    fetch(`/services/cflows/create-from-template/${currentTemplateId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create workflow');
    });
}

function submitCustomWorkflow(formData) {
    fetch('/services/cflows/create-custom-workflow/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create workflow');
    });
}

function submitCustomizedTemplate(formData) {
    fetch(`/services/cflows/customize-template/${currentTemplateId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create workflow');
    });
}

// Custom Field Functions
let customFieldCounter = 0;

function addCustomField(stepId) {
    customFieldCounter++;
    const fieldsContainer = document.getElementById(`customFields${stepId}`);
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'border border-gray-200 rounded-lg p-3 bg-gray-50';
    fieldDiv.id = `customField${stepId}_${customFieldCounter}`;
    
    fieldDiv.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <h6 class="text-sm font-medium text-gray-900">Custom Field ${customFieldCounter}</h6>
            <button type="button" onclick="removeCustomField('${stepId}', '${customFieldCounter}')" 
                    class="text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Field Name *</label>
                <input type="text" name="field_name_${stepId}_${customFieldCounter}" required
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500"
                       placeholder="field_name (no spaces)">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Display Label *</label>
                <input type="text" name="field_label_${stepId}_${customFieldCounter}" required
                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500"
                       placeholder="Field Label">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Field Type</label>
                <select name="field_type_${stepId}_${customFieldCounter}" onchange="handleFieldTypeChange('${stepId}', '${customFieldCounter}')"
                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500">
                    <option value="text">Text Input</option>
                    <option value="textarea">Text Area</option>
                    <option value="number">Number</option>
                    <option value="decimal">Decimal</option>
                    <option value="date">Date</option>
                    <option value="datetime">Date & Time</option>
                    <option value="checkbox">Checkbox</option>
                    <option value="select">Dropdown Select</option>
                    <option value="multiselect">Multiple Select</option>
                    <option value="email">Email</option>
                    <option value="url">URL</option>
                    <option value="phone">Phone Number</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="field_required_${stepId}_${customFieldCounter}" 
                       class="rounded text-purple-600 focus:ring-purple-500">
                <label class="ml-2 text-xs text-gray-700">Required field</label>
            </div>
        </div>
        <div class="mt-3">
            <label class="block text-xs font-medium text-gray-700 mb-1">Help Text</label>
            <input type="text" name="field_help_${stepId}_${customFieldCounter}"
                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500"
                   placeholder="Optional help text for users">
        </div>
        <div id="fieldOptions_${stepId}_${customFieldCounter}" class="mt-3 hidden">
            <label class="block text-xs font-medium text-gray-700 mb-1">Options (one per line)</label>
            <textarea name="field_options_${stepId}_${customFieldCounter}" rows="3"
                      class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500"
                      placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
        </div>
    `;
    
    fieldsContainer.appendChild(fieldDiv);
}

function removeCustomField(stepId, fieldId) {
    const fieldDiv = document.getElementById(`customField${stepId}_${fieldId}`);
    if (fieldDiv) {
        fieldDiv.remove();
    }
}

function handleFieldTypeChange(stepId, fieldId) {
    const fieldType = document.querySelector(`select[name="field_type_${stepId}_${fieldId}"]`).value;
    const optionsDiv = document.getElementById(`fieldOptions_${stepId}_${fieldId}`);
    
    if (fieldType === 'select' || fieldType === 'multiselect') {
        optionsDiv.classList.remove('hidden');
    } else {
        optionsDiv.classList.add('hidden');
    }
}

// Update collectCustomSteps to include custom fields
function collectCustomSteps() {
    const steps = [];
    const stepDivs = document.querySelectorAll('#customStepsList > div');
    
    stepDivs.forEach((stepDiv, index) => {
        const stepId = stepDiv.id.replace('customStep', '');
        const name = stepDiv.querySelector(`input[name="step_name_${stepId}"]`).value;
        
        if (name.trim()) {
            // Collect custom fields for this step
            const customFields = [];
            const fieldDivs = stepDiv.querySelectorAll(`#customFields${stepId} > div`);
            
            fieldDivs.forEach(fieldDiv => {
                const fieldId = fieldDiv.id.split('_')[1]; // Extract field counter
                const fieldName = fieldDiv.querySelector(`input[name="field_name_${stepId}_${fieldId}"]`)?.value;
                const fieldLabel = fieldDiv.querySelector(`input[name="field_label_${stepId}_${fieldId}"]`)?.value;
                
                if (fieldName && fieldLabel) {
                    const fieldType = fieldDiv.querySelector(`select[name="field_type_${stepId}_${fieldId}"]`).value;
                    const isRequired = fieldDiv.querySelector(`input[name="field_required_${stepId}_${fieldId}"]`).checked;
                    const helpText = fieldDiv.querySelector(`input[name="field_help_${stepId}_${fieldId}"]`).value;
                    const optionsText = fieldDiv.querySelector(`textarea[name="field_options_${stepId}_${fieldId}"]`)?.value;
                    
                    let options = [];
                    if (optionsText && (fieldType === 'select' || fieldType === 'multiselect')) {
                        options = optionsText.split('\n').filter(opt => opt.trim()).map(opt => opt.trim());
                    }
                    
                    customFields.push({
                        name: fieldName.trim(),
                        label: fieldLabel.trim(),
                        field_type: fieldType,
                        is_required: isRequired,
                        help_text: helpText,
                        options: options
                    });
                }
            });
            
            steps.push({
                name: name.trim(),
                description: stepDiv.querySelector(`input[name="step_description_${stepId}"]`).value,
                requires_booking: stepDiv.querySelector(`input[name="step_booking_${stepId}"]`).checked,
                estimated_duration_hours: parseFloat(stepDiv.querySelector(`input[name="step_duration_${stepId}"]`).value) || null,
                assigned_team_id: stepDiv.querySelector(`select[name="step_team_${stepId}"]`).value || null,
                custom_fields: customFields
            });
        }
    });
    
    return steps;
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const previewModal = document.getElementById('templatePreviewModal');
    const creationModal = document.getElementById('workflowCreationModal');
    
    if (event.target === previewModal) {
        closePreviewModal();
    }
    
    if (event.target === creationModal) {
        closeCreationModal();
    }
});
</script>
{% endblock %}